//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: playn/core/GroupLayerImpl.java
//
//  Created by Thomas on 7/1/13.
//

#import "AbstractLayer.h"
#import "GroupLayer.h"
#import "IOSClass.h"
#import "IOSObjectArray.h"
#import "Layer.h"
#import "Point.h"
#import "Transform.h"
#import "java/lang/UnsupportedOperationException.h"
#import "java/util/ArrayList.h"
#import "java/util/List.h"
#import "GroupLayerImpl.h"

@implementation PlaynCoreGroupLayerImpl

- (id<JavaUtilList>)children {
  return children_;
}
- (void)setChildren:(id<JavaUtilList>)children {
  JreOperatorRetainedAssign(&children_, self, children);
}
@synthesize children = children_;

- (int)addWithPlaynCoreGroupLayer:(id<PlaynCoreGroupLayer>)self_
                           withId:(PlaynCoreAbstractLayer *)child {
  id<PlaynCoreGroupLayer> parent = [((PlaynCoreAbstractLayer *) NIL_CHK(child)) parent];
  if (parent == self_) {
    return [self findChildWithId:child withFloat:[((PlaynCoreAbstractLayer *) NIL_CHK(child)) depth]];
  }
  int count = [((id<JavaUtilList>) NIL_CHK(children_)) size], index;
  if (count == 0 || [((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) getWithInt:count - 1]) depth] <= [((PlaynCoreAbstractLayer *) NIL_CHK(child)) depth]) {
    index = count;
  }
  else {
    index = [self findInsertionWithFloat:[((PlaynCoreAbstractLayer *) NIL_CHK(child)) depth]];
  }
  if (parent != nil) {
    [((id<PlaynCoreGroupLayer>) [((PlaynCoreAbstractLayer *) NIL_CHK(child)) parent]) removeWithPlaynCoreLayer:child];
  }
  [((id<JavaUtilList>) NIL_CHK(children_)) addWithInt:index withId:child];
  [((PlaynCoreAbstractLayer *) NIL_CHK(child)) setParentWithPlaynCoreGroupLayer:self_];
  [((PlaynCoreAbstractLayer *) NIL_CHK(child)) onAdd];
  if ([((PlaynCoreAbstractLayer *) NIL_CHK(child)) interactive]) (void) [((id<PlaynCoreGroupLayer>) NIL_CHK(self_)) setInteractiveWithBOOL:YES];
  return index;
}

- (void)addAtWithPlaynCoreGroupLayer:(id<PlaynCoreGroupLayer>)self_
                  withPlaynCoreLayer:(id<PlaynCoreLayer>)layer
                           withFloat:(float)tx
                           withFloat:(float)ty {
  (void) [((id<PlaynCoreLayer>) NIL_CHK(layer)) setTranslationWithFloat:tx withFloat:ty];
  [((id<PlaynCoreGroupLayer>) NIL_CHK(self_)) addWithPlaynCoreLayer:layer];
}

- (void)removeWithPlaynCoreGroupLayer:(id<PlaynCoreGroupLayer>)self_
                               withId:(PlaynCoreAbstractLayer *)child {
  int index = [self findChildWithId:child withFloat:[((PlaynCoreAbstractLayer *) NIL_CHK(child)) depth]];
  if (index < 0) {
    @throw [[[JavaLangUnsupportedOperationException alloc] initWithNSString:@"Could not remove Layer because it is not a child of the GroupLayer"] autorelease];
  }
  [self removeWithInt:index];
}

- (void)clearWithPlaynCoreGroupLayer:(id<PlaynCoreGroupLayer>)self_ {
  while (![((id<JavaUtilList>) NIL_CHK(children_)) isEmpty]) {
    [self removeWithInt:[((id<JavaUtilList>) NIL_CHK(children_)) size] - 1];
  }
}

- (void)destroyWithPlaynCoreGroupLayer:(id<PlaynCoreGroupLayer>)self_ {
  IOSObjectArray *toDestroy = [((id<JavaUtilList>) NIL_CHK(children_)) toArrayWithNSObjectArray:[[[IOSObjectArray alloc] initWithLength:[((id<JavaUtilList>) NIL_CHK(children_)) size] type:[IOSClass classWithClass:[PlaynCoreAbstractLayer class]]] autorelease]];
  [((id<PlaynCoreGroupLayer>) NIL_CHK(self_)) clear];
  {
    IOSObjectArray *a__ = toDestroy;
    int n__ = (int) [((IOSObjectArray *) NIL_CHK(a__)) count];
    for (int i__ = 0; i__ < n__; i__++) {
      PlaynCoreAbstractLayer *child = ((PlaynCoreAbstractLayer *) [((IOSObjectArray *) NIL_CHK(a__)) objectAtIndex:i__]);
      [((PlaynCoreAbstractLayer *) NIL_CHK(child)) destroy];
    }
  }
}

- (void)onAddWithPlaynCoreGroupLayer:(id<PlaynCoreGroupLayer>)self_ {
  for (int ii = 0, ll = [((id<JavaUtilList>) NIL_CHK(children_)) size]; ii < ll; ii++) {
    [((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) getWithInt:ii]) onAdd];
  }
}

- (void)onRemoveWithPlaynCoreGroupLayer:(id<PlaynCoreGroupLayer>)self_ {
  for (int ii = 0, ll = [((id<JavaUtilList>) NIL_CHK(children_)) size]; ii < ll; ii++) {
    [((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) getWithInt:ii]) onRemove];
  }
}

- (id<PlaynCoreLayer>)hitTestWithPlaynCoreGroupLayer:(id<PlaynCoreGroupLayer>)self_
                                withPythagorasFPoint:(PythagorasFPoint *)point {
  float x = ((PythagorasFPoint *) NIL_CHK(point)).x_, y = ((PythagorasFPoint *) NIL_CHK(point)).y_;
  BOOL sawInteractiveChild = NO;
  for (int ii = [((id<JavaUtilList>) NIL_CHK(children_)) size] - 1; ii >= 0; ii--) {
    PlaynCoreAbstractLayer *child = ((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) getWithInt:ii]);
    if (![((PlaynCoreAbstractLayer *) NIL_CHK(child)) interactive]) continue;
    sawInteractiveChild = YES;
    if (![((PlaynCoreAbstractLayer *) NIL_CHK(child)) visible]) continue;
    (void) [((id<PythagorasFTransform>) [((PlaynCoreAbstractLayer *) NIL_CHK(child)) transform]) inverseTransformWithPythagorasFIPoint:[((PythagorasFPoint *) NIL_CHK(point)) setWithFloat:x withFloat:y] withPythagorasFPoint:point];
    ((PythagorasFPoint *) NIL_CHK(point)).x_ += [((PlaynCoreAbstractLayer *) NIL_CHK(child)) originX];
    ((PythagorasFPoint *) NIL_CHK(point)).y_ += [((PlaynCoreAbstractLayer *) NIL_CHK(child)) originY];
    id<PlaynCoreLayer> l = [((PlaynCoreAbstractLayer *) NIL_CHK(child)) hitTestWithPythagorasFPoint:point];
    if (l != nil) return l;
  }
  if (!sawInteractiveChild && ![((PlaynCoreAbstractLayer *) self_) hasInteractors]) (void) [((id<PlaynCoreGroupLayer>) NIL_CHK(self_)) setInteractiveWithBOOL:NO];
  return nil;
}

- (int)depthChangedWithPlaynCoreGroupLayer:(id<PlaynCoreGroupLayer>)self_
                        withPlaynCoreLayer:(id<PlaynCoreLayer>)layer
                                 withFloat:(float)oldDepth {
  PlaynCoreAbstractLayer *child = (PlaynCoreAbstractLayer *) layer;
  int oldIndex = [self findChildWithId:child withFloat:oldDepth];
  float newDepth = [((PlaynCoreAbstractLayer *) NIL_CHK(child)) depth];
  BOOL leftCorrect = (oldIndex == 0 || [((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) getWithInt:oldIndex - 1]) depth] <= newDepth);
  BOOL rightCorrect = (oldIndex == [((id<JavaUtilList>) NIL_CHK(children_)) size] - 1 || [((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) getWithInt:oldIndex + 1]) depth] >= newDepth);
  if (leftCorrect && rightCorrect) {
    return oldIndex;
  }
  (void) [((id<JavaUtilList>) NIL_CHK(children_)) removeWithInt:oldIndex];
  int newIndex = [self findInsertionWithFloat:newDepth];
  [((id<JavaUtilList>) NIL_CHK(children_)) addWithInt:newIndex withId:child];
  return newIndex;
}

- (void)removeWithInt:(int)index {
  PlaynCoreAbstractLayer *child = ((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) removeWithInt:index]);
  [((PlaynCoreAbstractLayer *) NIL_CHK(child)) onRemove];
  [((PlaynCoreAbstractLayer *) NIL_CHK(child)) setParentWithPlaynCoreGroupLayer:nil];
}

- (int)findChildWithId:(PlaynCoreAbstractLayer *)child
             withFloat:(float)depth {
  int startIdx = [self findInsertionWithFloat:depth];
  for (int ii = startIdx - 1; ii >= 0; ii--) {
    PlaynCoreAbstractLayer *c = ((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) getWithInt:ii]);
    if (c == child) {
      return ii;
    }
    if ([((PlaynCoreAbstractLayer *) NIL_CHK(c)) depth] != depth) {
      break;
    }
  }
  for (int ii = startIdx, ll = [((id<JavaUtilList>) NIL_CHK(children_)) size]; ii < ll; ii++) {
    PlaynCoreAbstractLayer *c = ((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) getWithInt:ii]);
    if (c == child) {
      return ii;
    }
    if ([((PlaynCoreAbstractLayer *) NIL_CHK(c)) depth] != depth) {
      break;
    }
  }
  return -1;
}

- (int)findInsertionWithFloat:(float)depth {
  int low = 0, high = [((id<JavaUtilList>) NIL_CHK(children_)) size] - 1;
  while (low <= high) {
    int mid = (int) (((unsigned int) (low + high)) >> 1);
    float midDepth = [((PlaynCoreAbstractLayer *) [((id<JavaUtilList>) NIL_CHK(children_)) getWithInt:mid]) depth];
    if (depth > midDepth) {
      low = mid + 1;
    }
    else if (depth < midDepth) {
      high = mid - 1;
    }
    else {
      return mid;
    }
  }
  return low;
}

- (id)init {
  if ((self = [super init])) {
    JreOperatorRetainedAssign(&children_, self, [[[JavaUtilArrayList alloc] init] autorelease]);
  }
  return self;
}

- (void)dealloc {
  JreOperatorRetainedAssign(&children_, self, nil);
  [super dealloc];
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  PlaynCoreGroupLayerImpl *typedCopy = (PlaynCoreGroupLayerImpl *) copy;
  typedCopy.children = children_;
}

@end
