//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: core/src/main/java/tuxkids/tuxblocks/core/defense/Inventory.java
//
//  Created by Thomas on 7/26/13.
//

#include "IOSClass.h"
#include "IOSIntArray.h"
#include "IOSObjectArray.h"
#include "java/lang/Math.h"
#include "playn/core/Canvas.h"
#include "playn/core/CanvasImage.h"
#include "playn/core/Color.h"
#include "playn/core/Font.h"
#include "playn/core/Graphics.h"
#include "playn/core/GroupLayer.h"
#include "playn/core/Image.h"
#include "playn/core/ImageLayer.h"
#include "playn/core/Layer.h"
#include "playn/core/Pointer.h"
#include "playn/core/TextFormat.h"
#include "playn/core/TextLayout.h"
#include "tripleplay/util/Colors.h"
#include "tuxkids/tuxblocks/core/Button.h"
#include "tuxkids/tuxblocks/core/Constant.h"
#include "tuxkids/tuxblocks/core/GameState.h"
#include "tuxkids/tuxblocks/core/MenuSprite.h"
#include "tuxkids/tuxblocks/core/PlayNObject.h"
#include "tuxkids/tuxblocks/core/defense/DefenseScreen.h"
#include "tuxkids/tuxblocks/core/defense/Grid.h"
#include "tuxkids/tuxblocks/core/defense/Inventory.h"
#include "tuxkids/tuxblocks/core/defense/tower/Tower.h"
#include "tuxkids/tuxblocks/core/defense/tower/TowerType.h"
#include "tuxkids/tuxblocks/core/layers/ImageLayerTintable.h"
#include "tuxkids/tuxblocks/core/utils/CanvasUtils.h"

@implementation TuxkidsTuxblocksCoreDefenseInventory

@synthesize grid = grid_;
@synthesize groupLayer = groupLayer_;
@synthesize width = width_;
@synthesize height = height_;
@synthesize countSprites = countSprites_;
@synthesize itemButtons = itemButtons_;
@synthesize textFormat = textFormat_;
@synthesize screen = screen_;

- (id<PlaynCoreGroupLayer>)layer {
  return groupLayer_;
}

- (int)getItemSpriteSize {
  int wSize = (int) ((width_ - TuxkidsTuxblocksCoreDefenseInventory_ITEM_SPRITE_MARGIN * 2) / TuxkidsTuxblocksCoreDefenseInventory_COLS * 0.9f);
  int hSize = (int) ((height_ - TuxkidsTuxblocksCoreDefenseInventory_ITEM_SPRITE_MARGIN * 2) / [self rows] * 0.9f) - [self getItemCaptionHeight];
  return [JavaLangMath minWithInt:wSize withInt:hSize];
}

- (int)getItemCaptionHeight {
  return textFormat_ == nil ? 0 : (int) ([((id<PlaynCoreFont>) nil_chk(((PlaynCoreTextFormat *) nil_chk(textFormat_)).font)) size] + TuxkidsTuxblocksCoreDefenseInventory_ITEM_SPRITE_MARGIN);
}

- (float)getItemSpriteXWithInt:(int)index {
  int j = index % TuxkidsTuxblocksCoreDefenseInventory_COLS;
  float spriteWidth = width_ / TuxkidsTuxblocksCoreDefenseInventory_COLS;
  return width_ / 2 + (j - (TuxkidsTuxblocksCoreDefenseInventory_COLS - 1) * 0.5f) * spriteWidth;
}

- (int)rows {
  return ([TuxkidsTuxblocksCoreDefenseTowerTower towerCount] - 1) / TuxkidsTuxblocksCoreDefenseInventory_COLS + 1;
}

- (float)getItemSpriteYWithInt:(int)index {
  int i = index / TuxkidsTuxblocksCoreDefenseInventory_COLS;
  int rows = [self rows];
  float spriteHeight = [self getItemSpriteSize] + TuxkidsTuxblocksCoreDefenseInventory_ITEM_SPRITE_MARGIN * 2 + [self getItemCaptionHeight];
  return height_ / 2 + (i - (rows - 1) * 0.5f) * spriteHeight;
}

- (IOSIntArray *)towerCounts {
  return [((TuxkidsTuxblocksCoreGameState *) nil_chk([((TuxkidsTuxblocksCoreDefenseDefenseScreen *) nil_chk(screen_)) state])) towerCounts];
}

- (id)initWithTuxkidsTuxblocksCoreDefenseDefenseScreen:(TuxkidsTuxblocksCoreDefenseDefenseScreen *)screen
                   withTuxkidsTuxblocksCoreDefenseGrid:(TuxkidsTuxblocksCoreDefenseGrid *)grid
                                               withInt:(int)width
                                               withInt:(int)height {
  if ((self = [super init])) {
    groupLayer_ = [((id<PlaynCoreGraphics>) nil_chk([TuxkidsTuxblocksCorePlayNObject graphics])) createGroupLayer];
    self.screen = screen;
    self.grid = grid;
    self.width = width;
    self.height = height;
    textFormat_ = [((PlaynCoreTextFormat *) [[PlaynCoreTextFormat alloc] init]) withFontWithPlaynCoreFont:[((id<PlaynCoreGraphics>) nil_chk([TuxkidsTuxblocksCorePlayNObject graphics])) createFontWithNSString:[TuxkidsTuxblocksCoreConstant FONT_NAME] withPlaynCoreFont_StyleEnum:[PlaynCoreFont_StyleEnum BOLD] withFloat:[self getItemSpriteSize] / 7]];
    [self createSelectionSprites];
    [self createCountSprites];
    [((TuxkidsTuxblocksCoreGameState *) nil_chk([((TuxkidsTuxblocksCoreDefenseDefenseScreen *) nil_chk(screen)) state])) setInventoryChangedListenerWithTuxkidsTuxblocksCoreGameState_InventoryChangedListener:[[TuxkidsTuxblocksCoreDefenseInventory_$1 alloc] initWithTuxkidsTuxblocksCoreDefenseInventory:self]];
  }
  return self;
}

- (void)createCountSprites {
  countSprites_ = [IOSObjectArray arrayWithLength:(int) [((IOSIntArray *) nil_chk([self towerCounts])) count] type:[IOSClass classWithProtocol:@protocol(PlaynCoreImageLayer)]];
  for (int i = 0; i < (int) [((IOSObjectArray *) nil_chk(countSprites_)) count]; i++) {
    (void) [((IOSObjectArray *) nil_chk(countSprites_)) replaceObjectAtIndex:i withObject:[((id<PlaynCoreGraphics>) nil_chk([TuxkidsTuxblocksCorePlayNObject graphics])) createImageLayer]];
    (void) [((id<PlaynCoreImageLayer>) nil_chk([((IOSObjectArray *) nil_chk(countSprites_)) objectAtIndex:i])) setTranslationWithFloat:[self getItemSpriteXWithInt:i] - [self getItemSpriteSize] / 2 + TuxkidsTuxblocksCoreDefenseInventory_ITEM_SPRITE_MARGIN withFloat:[self getItemSpriteYWithInt:i] - [self getItemSpriteSize] / 2 - [self getItemCaptionHeight] / 2 + TuxkidsTuxblocksCoreDefenseInventory_ITEM_SPRITE_MARGIN];
    [((id<PlaynCoreGroupLayer>) nil_chk(groupLayer_)) addWithPlaynCoreLayer:[((IOSObjectArray *) nil_chk(countSprites_)) objectAtIndex:i]];
    [self refreshCountSpriteWithInt:i];
  }
}

- (void)refreshCountSprites {
  for (int i = 0; i < (int) [((IOSObjectArray *) nil_chk(countSprites_)) count]; i++) {
    [self refreshCountSpriteWithInt:i];
  }
}

- (void)refreshCountSpriteWithInt:(int)index {
  NSString *text = [NSString stringWithFormat:@"x%d", [((IOSIntArray *) nil_chk([self towerCounts])) intAtIndex:index]];
  id<PlaynCoreTextLayout> layout = [((id<PlaynCoreGraphics>) nil_chk([TuxkidsTuxblocksCorePlayNObject graphics])) layoutTextWithNSString:text withPlaynCoreTextFormat:textFormat_];
  id<PlaynCoreCanvasImage> image = [((id<PlaynCoreGraphics>) nil_chk([TuxkidsTuxblocksCorePlayNObject graphics])) createImageWithFloat:[((id<PlaynCoreTextLayout>) nil_chk(layout)) width] withFloat:[((id<PlaynCoreTextLayout>) nil_chk(layout)) height]];
  (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) setFillColorWithInt:[TripleplayUtilColors BLACK]];
  (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) fillTextWithPlaynCoreTextLayout:layout withFloat:0 withFloat:0];
  (void) [((id<PlaynCoreImageLayer>) nil_chk([((IOSObjectArray *) nil_chk(countSprites_)) objectAtIndex:index])) setImageWithPlaynCoreImage:image];
  [((TuxkidsTuxblocksCoreButton *) nil_chk([((IOSObjectArray *) nil_chk(itemButtons_)) objectAtIndex:index])) setEnabledWithBOOL:[((IOSIntArray *) nil_chk([self towerCounts])) intAtIndex:index] > 0];
}

- (void)createSelectionSprites {
  int spriteSize = [self getItemSpriteSize];
  int textHeight = [self getItemCaptionHeight];
  int rad = (int) (spriteSize * 0.05f);
  float padding = spriteSize * 0.1f;
  float cellSize = (spriteSize - padding * 2) / 3;
  float strokeWidth = 5;
  itemButtons_ = [IOSObjectArray arrayWithLength:[TuxkidsTuxblocksCoreDefenseTowerTower towerCount] type:[IOSClass classWithClass:[TuxkidsTuxblocksCoreButton class]]];
  for (int index = 0; index < (int) [((IOSObjectArray *) nil_chk(itemButtons_)) count]; index++) {
    TuxkidsTuxblocksCoreDefenseTowerTowerTypeEnum *towerType = [TuxkidsTuxblocksCoreDefenseTowerTower getTypeByIndexWithInt:index];
    id<PlaynCoreTextLayout> layout = [((id<PlaynCoreGraphics>) nil_chk([TuxkidsTuxblocksCorePlayNObject graphics])) layoutTextWithNSString:[((TuxkidsTuxblocksCoreDefenseTowerTower *) nil_chk([((TuxkidsTuxblocksCoreDefenseTowerTowerTypeEnum *) nil_chk(towerType)) instance])) name] withPlaynCoreTextFormat:textFormat_];
    float indentX = [JavaLangMath maxWithFloat:0 withFloat:[((id<PlaynCoreTextLayout>) nil_chk(layout)) width] - spriteSize] / 2;
    id<PlaynCoreCanvasImage> image = [((id<PlaynCoreGraphics>) nil_chk([TuxkidsTuxblocksCorePlayNObject graphics])) createImageWithFloat:[JavaLangMath maxWithFloat:spriteSize withFloat:[((id<PlaynCoreTextLayout>) nil_chk(layout)) width]] withFloat:spriteSize + textHeight];
    (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) setFillColorWithInt:[TripleplayUtilColors WHITE]];
    (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) fillRoundRectWithFloat:indentX withFloat:0 withFloat:spriteSize withFloat:spriteSize withFloat:rad];
    (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) setStrokeColorWithInt:[TripleplayUtilColors DARK_GRAY]];
    (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) setStrokeWidthWithFloat:strokeWidth];
    (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) strokeRoundRectWithFloat:indentX + strokeWidth / 2 - 1 withFloat:strokeWidth / 2 - 1 withFloat:spriteSize - strokeWidth + 2 withFloat:spriteSize - strokeWidth + 2 withFloat:rad];
    id<PlaynCoreImage> towerImage = [((TuxkidsTuxblocksCoreDefenseTowerTower *) nil_chk([((TuxkidsTuxblocksCoreDefenseTowerTowerTypeEnum *) nil_chk(towerType)) instance])) createImageWithFloat:cellSize withInt:[((TuxkidsTuxblocksCoreDefenseGrid *) nil_chk(grid_)) towerColor]];
    (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) drawImageWithPlaynCoreImage:towerImage withFloat:indentX + (spriteSize - [((id<PlaynCoreImage>) nil_chk(towerImage)) width]) / 2 withFloat:(spriteSize - [((id<PlaynCoreImage>) nil_chk(towerImage)) height]) / 2];
    (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) setFillColorWithInt:[TripleplayUtilColors WHITE]];
    (void) [((id<PlaynCoreCanvas>) nil_chk([((id<PlaynCoreCanvasImage>) nil_chk(image)) canvas])) fillTextWithPlaynCoreTextLayout:layout withFloat:([((id<PlaynCoreCanvasImage>) nil_chk(image)) width] - [((id<PlaynCoreTextLayout>) nil_chk(layout)) width]) / 2 withFloat:[((id<PlaynCoreCanvasImage>) nil_chk(image)) height] - textHeight + TuxkidsTuxblocksCoreDefenseInventory_ITEM_SPRITE_MARGIN / 2];
    TuxkidsTuxblocksCoreButton *button = [[TuxkidsTuxblocksCoreButton alloc] initWithPlaynCoreImage:image withBOOL:NO];
    float x = [self getItemSpriteXWithInt:index];
    float y = [self getItemSpriteYWithInt:index];
    [((TuxkidsTuxblocksCoreButton *) nil_chk(button)) setPositionWithFloat:x withFloat:y];
    [((TuxkidsTuxblocksCoreButton *) nil_chk(button)) setTintWithInt:[TripleplayUtilColors WHITE] withInt:[PlaynCoreColor rgbWithInt:230 withInt:230 withInt:230]];
    int fi = index;
    [((TuxkidsTuxblocksCoreLayersImageLayerTintable *) nil_chk([((TuxkidsTuxblocksCoreButton *) nil_chk(button)) imageLayer])) addListenerWithPlaynCorePointer_Listener:[[TuxkidsTuxblocksCoreDefenseInventory_$2 alloc] initWithTuxkidsTuxblocksCoreDefenseInventory:self withTuxkidsTuxblocksCoreButton:button withTuxkidsTuxblocksCoreDefenseTowerTowerTypeEnum:towerType withInt:fi]];
    [((id<PlaynCoreGroupLayer>) nil_chk(groupLayer_)) addWithPlaynCoreLayer:[((TuxkidsTuxblocksCoreButton *) nil_chk(button)) layerAddable]];
    (void) [((IOSObjectArray *) nil_chk(itemButtons_)) replaceObjectAtIndex:index withObject:button];
  }
}

- (void)createBackgroundSprite {
  id<PlaynCoreImage> image = [TuxkidsTuxblocksCoreUtilsCanvasUtils createRectWithFloat:width_ withFloat:height_ withInt:[PlaynCoreColor rgbWithInt:200 withInt:125 withInt:125] withFloat:1 withInt:[TripleplayUtilColors DARK_GRAY]];
  id<PlaynCoreImageLayer> layer = [((id<PlaynCoreGraphics>) nil_chk([TuxkidsTuxblocksCorePlayNObject graphics])) createImageLayerWithPlaynCoreImage:image];
  (void) [((id<PlaynCoreImageLayer>) nil_chk(layer)) setAlphaWithFloat:[TuxkidsTuxblocksCoreMenuSprite DEFAULT_ALPHA]];
  [((id<PlaynCoreGroupLayer>) nil_chk(groupLayer_)) addWithPlaynCoreLayer:layer];
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TuxkidsTuxblocksCoreDefenseInventory *typedCopy = (TuxkidsTuxblocksCoreDefenseInventory *) copy;
  typedCopy.grid = grid_;
  typedCopy.groupLayer = groupLayer_;
  typedCopy.width = width_;
  typedCopy.height = height_;
  typedCopy.countSprites = countSprites_;
  typedCopy.itemButtons = itemButtons_;
  typedCopy.textFormat = textFormat_;
  typedCopy.screen = screen_;
}

@end
@implementation TuxkidsTuxblocksCoreDefenseInventory_$1

@synthesize this$0 = this$0_;

- (void)onInventoryChangedWithInt:(int)index
                          withInt:(int)count {
  [this$0_ refreshCountSpriteWithInt:index];
}

- (id)initWithTuxkidsTuxblocksCoreDefenseInventory:(TuxkidsTuxblocksCoreDefenseInventory *)outer$ {
  if ((self = [super init])) {
    this$0_ = outer$;
  }
  return self;
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TuxkidsTuxblocksCoreDefenseInventory_$1 *typedCopy = (TuxkidsTuxblocksCoreDefenseInventory_$1 *) copy;
  typedCopy.this$0 = this$0_;
}

@end
@implementation TuxkidsTuxblocksCoreDefenseInventory_$2

@synthesize this$0 = this$0_;
@synthesize val$button = val$button_;
@synthesize val$towerType = val$towerType_;
@synthesize val$fi = val$fi_;

- (void)onPointerStartWithPlaynCorePointer_Event:(id<PlaynCorePointer_Event>)event {
  if (![((TuxkidsTuxblocksCoreButton *) nil_chk(val$button_)) enabled]) return;
  [((TuxkidsTuxblocksCoreDefenseGrid *) nil_chk(this$0_.grid)) startPlacementWithTuxkidsTuxblocksCoreDefenseTowerTower:[((TuxkidsTuxblocksCoreDefenseTowerTowerTypeEnum *) nil_chk(val$towerType_)) newInstance]];
}

- (void)onPointerEndWithPlaynCorePointer_Event:(id<PlaynCorePointer_Event>)event {
  if (![((TuxkidsTuxblocksCoreButton *) nil_chk(val$button_)) enabled]) return;
  if ([((TuxkidsTuxblocksCoreDefenseGrid *) nil_chk(this$0_.grid)) endPlacementWithFloat:[((id<PlaynCorePointer_Event>) nil_chk(event)) x] withFloat:[((id<PlaynCorePointer_Event>) nil_chk(event)) y]]) {
    (*[((IOSIntArray *) nil_chk([this$0_ towerCounts])) intRefAtIndex:val$fi_])--;
    [this$0_ refreshCountSpriteWithInt:val$fi_];
  }
}

- (void)onPointerDragWithPlaynCorePointer_Event:(id<PlaynCorePointer_Event>)event {
  if (![((TuxkidsTuxblocksCoreButton *) nil_chk(val$button_)) enabled]) return;
  [((TuxkidsTuxblocksCoreDefenseGrid *) nil_chk(this$0_.grid)) updatePlacementWithFloat:[((id<PlaynCorePointer_Event>) nil_chk(event)) x] withFloat:[((id<PlaynCorePointer_Event>) nil_chk(event)) y]];
}

- (void)onPointerCancelWithPlaynCorePointer_Event:(id<PlaynCorePointer_Event>)event {
}

- (id)initWithTuxkidsTuxblocksCoreDefenseInventory:(TuxkidsTuxblocksCoreDefenseInventory *)outer$
                    withTuxkidsTuxblocksCoreButton:(TuxkidsTuxblocksCoreButton *)capture$0
 withTuxkidsTuxblocksCoreDefenseTowerTowerTypeEnum:(TuxkidsTuxblocksCoreDefenseTowerTowerTypeEnum *)capture$1
                                           withInt:(int)capture$2 {
  if ((self = [super init])) {
    this$0_ = outer$;
    val$button_ = capture$0;
    val$towerType_ = capture$1;
    val$fi_ = capture$2;
  }
  return self;
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TuxkidsTuxblocksCoreDefenseInventory_$2 *typedCopy = (TuxkidsTuxblocksCoreDefenseInventory_$2 *) copy;
  typedCopy.this$0 = this$0_;
  typedCopy.val$button = val$button_;
  typedCopy.val$towerType = val$towerType_;
  typedCopy.val$fi = val$fi_;
}

@end
