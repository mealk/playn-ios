//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: tripleplay/gesture/GestureDirector.java
//
//  Created by Thomas on 7/10/13.
//

#import "IOSClass.h"
#import "IOSObjectArray.h"
#import "java/lang/Integer.h"
#import "java/util/ArrayList.h"
#import "java/util/HashMap.h"
#import "java/util/HashSet.h"
#import "java/util/Iterator.h"
#import "java/util/List.h"
#import "java/util/Map.h"
#import "java/util/Set.h"
#import "playn/core/Touch.h"
#import "pythagoras/f/IRectangle.h"
#import "react/Value.h"
#import "react/ValueView.h"
#import "tripleplay/gesture/Gesture.h"
#import "tripleplay/gesture/GestureDirector.h"
#import "tripleplay/gesture/GestureNode.h"
#import "tripleplay/gesture/Log.h"
#import "tripleplay/util/Logger.h"
#import "tripleplay/util/Timer.h"

@implementation TripleplayGestureGestureDirector

@synthesize bounds = bounds_;
@synthesize _timer = _timer_;
@synthesize _currentTouches = _currentTouches_;
@synthesize _currentMoves = _currentMoves_;
@synthesize _gestures = _gestures_;
@synthesize _greedy = _greedy_;

+ (int)PAUSE_DELAY {
  return TripleplayGestureGestureDirector_PAUSE_DELAY;
}

- (id)initWithPythagorasFIRectangle:(id<PythagorasFIRectangle>)bounds
            withTripleplayUtilTimer:(TripleplayUtilTimer *)timer {
  if ((self = [super init])) {
    _currentTouches_ = [[JavaUtilHashMap alloc] init];
    _currentMoves_ = [[JavaUtilHashMap alloc] init];
    _gestures_ = [[JavaUtilHashSet alloc] init];
    _greedy_ = ((ReactValue *) [ReactValue createWithId:nil]);
    self.bounds = bounds;
    _timer_ = timer;
  }
  return self;
}

- (TripleplayGestureGestureDirector *)addWithTripleplayGestureGesture:(id<TripleplayGestureGesture>)gesture {
  [((id<JavaUtilSet>) NIL_CHK(_gestures_)) addWithId:gesture];
  return self;
}

- (BOOL)removeWithTripleplayGestureGesture:(id<TripleplayGestureGesture>)gesture {
  return [((id<JavaUtilSet>) NIL_CHK(_gestures_)) removeWithId:gesture];
}

- (BOOL)touchInBoundsWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  return [((id<PythagorasFIRectangle>) NIL_CHK(bounds_)) containsWithFloat:[((id<PlaynCoreTouch_Event>) NIL_CHK(touch)) localX] withFloat:[((id<PlaynCoreTouch_Event>) NIL_CHK(touch)) localY]];
}

- (BOOL)trackingTouchWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  return [((id<JavaUtilMap>) NIL_CHK(_currentTouches_)) containsKeyWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) NIL_CHK(touch)) id__]]];
}

- (id<ReactValueView>)greedyGesture {
  return _greedy_;
}

- (void)onTouchStartWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self touchInBoundsWithPlaynCoreTouch_Event:touch]) return;
  if ([((id<JavaUtilMap>) NIL_CHK(_currentTouches_)) isEmpty]) {
    {
      id<JavaUtilIterator> iter__ = ((id<JavaUtilIterator>) [((id<JavaUtilSet>) NIL_CHK(_gestures_)) iterator]);
      while ([((id<JavaUtilIterator>) NIL_CHK(iter__)) hasNext]) {
        id<TripleplayGestureGesture> gesture = ((id<TripleplayGestureGesture>) [((id<JavaUtilIterator>) NIL_CHK(iter__)) next]);
        [((id<TripleplayGestureGesture>) NIL_CHK(gesture)) start];
      }
    }
    (void) [((ReactValue *) NIL_CHK(_greedy_)) updateWithId:nil];
  }
  (void) [((id<JavaUtilMap>) NIL_CHK(_currentTouches_)) putWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) NIL_CHK(touch)) id__]] withId:touch];
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum START] withPlaynCoreTouch_Event:touch]];
}

- (void)onTouchMoveWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self trackingTouchWithPlaynCoreTouch_Event:touch]) return;
  (void) [((id<JavaUtilMap>) NIL_CHK(_currentTouches_)) putWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) NIL_CHK(touch)) id__]] withId:touch];
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum MOVE] withPlaynCoreTouch_Event:touch]];
}

- (void)onTouchEndWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self trackingTouchWithPlaynCoreTouch_Event:touch]) return;
  (void) [((id<JavaUtilMap>) NIL_CHK(_currentTouches_)) removeWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) NIL_CHK(touch)) id__]]];
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum END] withPlaynCoreTouch_Event:touch]];
}

- (void)onTouchCancelWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self trackingTouchWithPlaynCoreTouch_Event:touch]) return;
  (void) [((id<JavaUtilMap>) NIL_CHK(_currentTouches_)) removeWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) NIL_CHK(touch)) id__]]];
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum CANCEL] withPlaynCoreTouch_Event:touch]];
}

- (void)onTouchPauseWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self trackingTouchWithPlaynCoreTouch_Event:touch]) {
    [((TripleplayUtilLogger *) NIL_CHK([TripleplayGestureLog log])) warningWithNSString:@"Bad state: received pause dispatch for an event we're not tracking" withNSObjectArray:[IOSObjectArray arrayWithType:[IOSClass classWithClass:[NSObject class]] count:2, @"event", touch ]];
    return;
  }
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum PAUSE] withPlaynCoreTouch_Event:touch]];
}

- (void)evaluateGesturesWithTripleplayGestureGestureNode:(TripleplayGestureGestureNode *)node {
  id<TripleplayUtilTimer_Handle> handle = ((id<TripleplayUtilTimer_Handle>) [((id<JavaUtilMap>) NIL_CHK(_currentMoves_)) removeWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) NIL_CHK(node.touch)) id__]]]);
  if (handle != nil) [handle cancel];
  if (((TripleplayGestureGestureNode *) NIL_CHK(node)).type == [TripleplayGestureGestureNode_TypeEnum MOVE] || ((TripleplayGestureGestureNode *) NIL_CHK(node)).type == [TripleplayGestureGestureNode_TypeEnum START]) {
    handle = [((TripleplayUtilTimer *) NIL_CHK(_timer_)) afterWithInt:TripleplayGestureGestureDirector_PAUSE_DELAY withJavaLangRunnable:[[TripleplayGestureGestureDirector_$1 alloc] initWithTripleplayGestureGestureDirector:self withTripleplayGestureGestureNode:node]];
    (void) [((id<JavaUtilMap>) NIL_CHK(_currentMoves_)) putWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) NIL_CHK(node.touch)) id__]] withId:handle];
  }
  id<TripleplayGestureGesture> currentGreedy = ((id<TripleplayGestureGesture>) [((ReactValue *) NIL_CHK(_greedy_)) get]);
  if (currentGreedy != nil) {
    [currentGreedy evaluateWithTripleplayGestureGestureNode:node];
    return;
  }
  id<JavaUtilList> greedy = [[JavaUtilArrayList alloc] init];
  id<JavaUtilList> complete = [[JavaUtilArrayList alloc] init];
  {
    id<JavaUtilIterator> iter__ = ((id<JavaUtilIterator>) [((id<JavaUtilSet>) NIL_CHK(_gestures_)) iterator]);
    while ([((id<JavaUtilIterator>) NIL_CHK(iter__)) hasNext]) {
      id<TripleplayGestureGesture> gesture = ((id<TripleplayGestureGesture>) [((id<JavaUtilIterator>) NIL_CHK(iter__)) next]);
      if ([((id<TripleplayGestureGesture>) NIL_CHK(gesture)) state] == [TripleplayGestureGesture_StateEnum UNQUALIFIED]) continue;
      [((id<TripleplayGestureGesture>) NIL_CHK(gesture)) evaluateWithTripleplayGestureGestureNode:node];
      if ([((id<TripleplayGestureGesture>) NIL_CHK(gesture)) state] == [TripleplayGestureGesture_StateEnum GREEDY]) [((id<JavaUtilList>) NIL_CHK(greedy)) addWithId:gesture];
      else if ([((id<TripleplayGestureGesture>) NIL_CHK(gesture)) state] == [TripleplayGestureGesture_StateEnum COMPLETE]) [((id<JavaUtilList>) NIL_CHK(complete)) addWithId:gesture];
    }
  }
  int greedyAndComplete = [((id<JavaUtilList>) NIL_CHK(greedy)) size] + [((id<JavaUtilList>) NIL_CHK(complete)) size];
  if (greedyAndComplete > 1) {
    [((TripleplayUtilLogger *) NIL_CHK([TripleplayGestureLog log])) warningWithNSString:@"More than one gesture transitioned to GREEDY or COMPLETE on a single node" withNSObjectArray:[IOSObjectArray arrayWithType:[IOSClass classWithClass:[NSObject class]] count:6, @"node", node, @"greedy", greedy, @"complete", complete ]];
  }
  (void) [((ReactValue *) NIL_CHK(_greedy_)) updateWithId:currentGreedy = ([((id<JavaUtilList>) NIL_CHK(greedy)) isEmpty] ? nil : ((id<TripleplayGestureGesture>) [((id<JavaUtilList>) NIL_CHK(greedy)) getWithInt:0]))];
  if (greedyAndComplete > 0) {
    {
      id<JavaUtilIterator> iter__ = ((id<JavaUtilIterator>) [((id<JavaUtilSet>) NIL_CHK(_gestures_)) iterator]);
      while ([((id<JavaUtilIterator>) NIL_CHK(iter__)) hasNext]) {
        id<TripleplayGestureGesture> gesture = ((id<TripleplayGestureGesture>) [((id<JavaUtilIterator>) NIL_CHK(iter__)) next]);
        if (currentGreedy != gesture) [((id<TripleplayGestureGesture>) NIL_CHK(gesture)) cancel];
      }
    }
  }
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayGestureGestureDirector *typedCopy = (TripleplayGestureGestureDirector *) copy;
  typedCopy.bounds = bounds_;
  typedCopy._timer = _timer_;
  typedCopy._currentTouches = _currentTouches_;
  typedCopy._currentMoves = _currentMoves_;
  typedCopy._gestures = _gestures_;
  typedCopy._greedy = _greedy_;
}

@end
@implementation TripleplayGestureGestureDirector_$1

@synthesize this$0 = this$0_;
@synthesize val$node = val$node_;

- (void)run {
  [this$0_ onTouchPauseWithPlaynCoreTouch_Event:((TripleplayGestureGestureNode *) NIL_CHK(val$node_)).touch];
}

- (id)initWithTripleplayGestureGestureDirector:(TripleplayGestureGestureDirector *)outer$
              withTripleplayGestureGestureNode:(TripleplayGestureGestureNode *)capture$0 {
  if ((self = [super init])) {
    this$0_ = outer$;
    val$node_ = capture$0;
  }
  return self;
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayGestureGestureDirector_$1 *typedCopy = (TripleplayGestureGestureDirector_$1 *) copy;
  typedCopy.this$0 = this$0_;
  typedCopy.val$node = val$node_;
}

@end
