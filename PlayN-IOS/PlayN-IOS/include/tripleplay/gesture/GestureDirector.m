//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: tripleplay/gesture/GestureDirector.java
//
//  Created by Thomas on 7/25/13.
//

#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "java/lang/Integer.h"
#include "java/util/ArrayList.h"
#include "java/util/HashMap.h"
#include "java/util/HashSet.h"
#include "java/util/Iterator.h"
#include "java/util/List.h"
#include "java/util/Map.h"
#include "java/util/Set.h"
#include "playn/core/Touch.h"
#include "pythagoras/f/IRectangle.h"
#include "react/Value.h"
#include "react/ValueView.h"
#include "tripleplay/gesture/Gesture.h"
#include "tripleplay/gesture/GestureDirector.h"
#include "tripleplay/gesture/GestureNode.h"
#include "tripleplay/gesture/Log.h"
#include "tripleplay/util/Logger.h"
#include "tripleplay/util/Timer.h"

@implementation TripleplayGestureGestureDirector

@synthesize bounds = bounds_;
@synthesize _timer = _timer_;
@synthesize _currentTouches = _currentTouches_;
@synthesize _currentMoves = _currentMoves_;
@synthesize _gestures = _gestures_;
@synthesize _greedy = _greedy_;

+ (int)PAUSE_DELAY {
  return TripleplayGestureGestureDirector_PAUSE_DELAY;
}

- (id)initWithPythagorasFIRectangle:(id<PythagorasFIRectangle>)bounds
            withTripleplayUtilTimer:(TripleplayUtilTimer *)timer {
  if ((self = [super init])) {
    _currentTouches_ = [[JavaUtilHashMap alloc] init];
    _currentMoves_ = [[JavaUtilHashMap alloc] init];
    _gestures_ = [[JavaUtilHashSet alloc] init];
    _greedy_ = [ReactValue createWithId:nil];
    self.bounds = bounds;
    _timer_ = timer;
  }
  return self;
}

- (TripleplayGestureGestureDirector *)addWithTripleplayGestureGesture:(id<TripleplayGestureGesture>)gesture {
  [((id<JavaUtilSet>) nil_chk(_gestures_)) addWithId:gesture];
  return self;
}

- (BOOL)removeWithTripleplayGestureGesture:(id<TripleplayGestureGesture>)gesture {
  return [((id<JavaUtilSet>) nil_chk(_gestures_)) removeWithId:gesture];
}

- (BOOL)touchInBoundsWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  return [((id<PythagorasFIRectangle>) nil_chk(bounds_)) containsWithFloat:[((id<PlaynCoreTouch_Event>) nil_chk(touch)) localX] withFloat:[((id<PlaynCoreTouch_Event>) nil_chk(touch)) localY]];
}

- (BOOL)trackingTouchWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  return [((id<JavaUtilMap>) nil_chk(_currentTouches_)) containsKeyWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) nil_chk(touch)) id__]]];
}

- (id<ReactValueView>)greedyGesture {
  return _greedy_;
}

- (void)onTouchStartWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self touchInBoundsWithPlaynCoreTouch_Event:touch]) return;
  if ([((id<JavaUtilMap>) nil_chk(_currentTouches_)) isEmpty]) {
    {
      id<JavaUtilIterator> iter__ = [((id<JavaUtilSet>) nil_chk(_gestures_)) iterator];
      while ([((id<JavaUtilIterator>) nil_chk(iter__)) hasNext]) {
        id<TripleplayGestureGesture> gesture = [((id<JavaUtilIterator>) nil_chk(iter__)) next];
        [((id<TripleplayGestureGesture>) nil_chk(gesture)) start];
      }
    }
    (void) [((ReactValue *) nil_chk(_greedy_)) updateWithId:nil];
  }
  (void) [((id<JavaUtilMap>) nil_chk(_currentTouches_)) putWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) nil_chk(touch)) id__]] withId:touch];
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum START] withPlaynCoreTouch_Event:touch]];
}

- (void)onTouchMoveWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self trackingTouchWithPlaynCoreTouch_Event:touch]) return;
  (void) [((id<JavaUtilMap>) nil_chk(_currentTouches_)) putWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) nil_chk(touch)) id__]] withId:touch];
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum MOVE] withPlaynCoreTouch_Event:touch]];
}

- (void)onTouchEndWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self trackingTouchWithPlaynCoreTouch_Event:touch]) return;
  (void) [((id<JavaUtilMap>) nil_chk(_currentTouches_)) removeWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) nil_chk(touch)) id__]]];
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum END] withPlaynCoreTouch_Event:touch]];
}

- (void)onTouchCancelWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self trackingTouchWithPlaynCoreTouch_Event:touch]) return;
  (void) [((id<JavaUtilMap>) nil_chk(_currentTouches_)) removeWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) nil_chk(touch)) id__]]];
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum CANCEL] withPlaynCoreTouch_Event:touch]];
}

- (void)onTouchPauseWithPlaynCoreTouch_Event:(id<PlaynCoreTouch_Event>)touch {
  if (![self trackingTouchWithPlaynCoreTouch_Event:touch]) {
    [((TripleplayUtilLogger *) nil_chk([TripleplayGestureLog log])) warningWithNSString:@"Bad state: received pause dispatch for an event we're not tracking" withNSObjectArray:[IOSObjectArray arrayWithObjects:(id[]){ @"event", touch } count:2 type:[IOSClass classWithClass:[NSObject class]]]];
    return;
  }
  [self evaluateGesturesWithTripleplayGestureGestureNode:[[TripleplayGestureGestureNode alloc] initWithTripleplayGestureGestureNode_TypeEnum:[TripleplayGestureGestureNode_TypeEnum PAUSE] withPlaynCoreTouch_Event:touch]];
}

- (void)evaluateGesturesWithTripleplayGestureGestureNode:(TripleplayGestureGestureNode *)node {
  id<TripleplayUtilTimer_Handle> handle = [((id<JavaUtilMap>) nil_chk(_currentMoves_)) removeWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) nil_chk(((TripleplayGestureGestureNode *) nil_chk(node)).touch)) id__]]];
  if (handle != nil) [handle cancel];
  if (((TripleplayGestureGestureNode *) nil_chk(node)).type == [TripleplayGestureGestureNode_TypeEnum MOVE] || ((TripleplayGestureGestureNode *) nil_chk(node)).type == [TripleplayGestureGestureNode_TypeEnum START]) {
    handle = [((TripleplayUtilTimer *) nil_chk(_timer_)) afterWithInt:TripleplayGestureGestureDirector_PAUSE_DELAY withJavaLangRunnable:[[TripleplayGestureGestureDirector_$1 alloc] initWithTripleplayGestureGestureDirector:self withTripleplayGestureGestureNode:node]];
    (void) [((id<JavaUtilMap>) nil_chk(_currentMoves_)) putWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreTouch_Event>) nil_chk(((TripleplayGestureGestureNode *) nil_chk(node)).touch)) id__]] withId:handle];
  }
  id<TripleplayGestureGesture> currentGreedy = [((ReactValue *) nil_chk(_greedy_)) get];
  if (currentGreedy != nil) {
    [currentGreedy evaluateWithTripleplayGestureGestureNode:node];
    return;
  }
  id<JavaUtilList> greedy = [[JavaUtilArrayList alloc] init];
  id<JavaUtilList> complete = [[JavaUtilArrayList alloc] init];
  {
    id<JavaUtilIterator> iter__ = [((id<JavaUtilSet>) nil_chk(_gestures_)) iterator];
    while ([((id<JavaUtilIterator>) nil_chk(iter__)) hasNext]) {
      id<TripleplayGestureGesture> gesture = [((id<JavaUtilIterator>) nil_chk(iter__)) next];
      if ([((id<TripleplayGestureGesture>) nil_chk(gesture)) state] == [TripleplayGestureGesture_StateEnum UNQUALIFIED]) continue;
      [((id<TripleplayGestureGesture>) nil_chk(gesture)) evaluateWithTripleplayGestureGestureNode:node];
      if ([((id<TripleplayGestureGesture>) nil_chk(gesture)) state] == [TripleplayGestureGesture_StateEnum GREEDY]) [((id<JavaUtilList>) nil_chk(greedy)) addWithId:gesture];
      else if ([((id<TripleplayGestureGesture>) nil_chk(gesture)) state] == [TripleplayGestureGesture_StateEnum COMPLETE]) [((id<JavaUtilList>) nil_chk(complete)) addWithId:gesture];
    }
  }
  int greedyAndComplete = [((id<JavaUtilList>) nil_chk(greedy)) size] + [((id<JavaUtilList>) nil_chk(complete)) size];
  if (greedyAndComplete > 1) {
    [((TripleplayUtilLogger *) nil_chk([TripleplayGestureLog log])) warningWithNSString:@"More than one gesture transitioned to GREEDY or COMPLETE on a single node" withNSObjectArray:[IOSObjectArray arrayWithObjects:(id[]){ @"node", node, @"greedy", greedy, @"complete", complete } count:6 type:[IOSClass classWithClass:[NSObject class]]]];
  }
  (void) [((ReactValue *) nil_chk(_greedy_)) updateWithId:currentGreedy = ([((id<JavaUtilList>) nil_chk(greedy)) isEmpty] ? nil : [((id<JavaUtilList>) nil_chk(greedy)) getWithInt:0])];
  if (greedyAndComplete > 0) {
    {
      id<JavaUtilIterator> iter__ = [((id<JavaUtilSet>) nil_chk(_gestures_)) iterator];
      while ([((id<JavaUtilIterator>) nil_chk(iter__)) hasNext]) {
        id<TripleplayGestureGesture> gesture = [((id<JavaUtilIterator>) nil_chk(iter__)) next];
        if (currentGreedy != gesture) [((id<TripleplayGestureGesture>) nil_chk(gesture)) cancel];
      }
    }
  }
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayGestureGestureDirector *typedCopy = (TripleplayGestureGestureDirector *) copy;
  typedCopy.bounds = bounds_;
  typedCopy._timer = _timer_;
  typedCopy._currentTouches = _currentTouches_;
  typedCopy._currentMoves = _currentMoves_;
  typedCopy._gestures = _gestures_;
  typedCopy._greedy = _greedy_;
}

@end
@implementation TripleplayGestureGestureDirector_$1

@synthesize this$0 = this$0_;
@synthesize val$node = val$node_;

- (void)run {
  [this$0_ onTouchPauseWithPlaynCoreTouch_Event:((TripleplayGestureGestureNode *) nil_chk(val$node_)).touch];
}

- (id)initWithTripleplayGestureGestureDirector:(TripleplayGestureGestureDirector *)outer$
              withTripleplayGestureGestureNode:(TripleplayGestureGestureNode *)capture$0 {
  if ((self = [super init])) {
    this$0_ = outer$;
    val$node_ = capture$0;
  }
  return self;
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayGestureGestureDirector_$1 *typedCopy = (TripleplayGestureGestureDirector_$1 *) copy;
  typedCopy.this$0 = this$0_;
  typedCopy.val$node = val$node_;
}

@end
