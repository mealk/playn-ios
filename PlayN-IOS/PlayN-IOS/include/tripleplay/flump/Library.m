//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: tripleplay/flump/Library.java
//
//  Created by Thomas on 7/25/13.
//

#include "IOSClass.h"
#include "java/lang/Exception.h"
#include "java/lang/IllegalArgumentException.h"
#include "java/lang/Integer.h"
#include "java/util/ArrayList.h"
#include "java/util/Collections.h"
#include "java/util/HashMap.h"
#include "java/util/Iterator.h"
#include "java/util/List.h"
#include "java/util/Map.h"
#include "playn/core/Asserts.h"
#include "playn/core/Assets.h"
#include "playn/core/Image.h"
#include "playn/core/Json.h"
#include "playn/core/PlayN.h"
#include "playn/core/util/Callback.h"
#include "react/Connection.h"
#include "react/Value.h"
#include "tripleplay/flump/Instance.h"
#include "tripleplay/flump/KeyframeData.h"
#include "tripleplay/flump/LayerData.h"
#include "tripleplay/flump/Library.h"
#include "tripleplay/flump/Movie.h"
#include "tripleplay/flump/Symbol.h"
#include "tripleplay/flump/Texture.h"

@implementation TripleplayFlumpLibrary

@synthesize frameRate = frameRate_;
@synthesize symbols = symbols_;

- (id)initWithPlaynCoreJson_Object:(id<PlaynCoreJson_Object>)json
                      withNSString:(NSString *)baseDir
         withPlaynCoreUtilCallback:(id<PlaynCoreUtilCallback>)callback {
  if ((self = [super init])) {
    frameRate_ = [((id<PlaynCoreJson_Object>) nil_chk(json)) getNumberWithNSString:@"frameRate"];
    id<JavaUtilMap> symbols = [[JavaUtilHashMap alloc] init];
    self.symbols = [JavaUtilCollections unmodifiableMapWithJavaUtilMap:symbols];
    JavaUtilArrayList *movies = [[JavaUtilArrayList alloc] init];
    {
      id<JavaUtilIterator> iter__ = [((id<PlaynCoreJson_TypedArray>) nil_chk([((id<PlaynCoreJson_Object>) nil_chk(json)) getArrayWithNSString:@"movies" withIOSClass:[IOSClass classWithProtocol:@protocol(PlaynCoreJson_Object)]])) iterator];
      while ([((id<JavaUtilIterator>) nil_chk(iter__)) hasNext]) {
        id<PlaynCoreJson_Object> movieJson = [((id<JavaUtilIterator>) nil_chk(iter__)) next];
        TripleplayFlumpMovie_Symbol *movie = [[TripleplayFlumpMovie_Symbol alloc] initWithTripleplayFlumpLibrary:self withPlaynCoreJson_Object:movieJson];
        [((JavaUtilArrayList *) nil_chk(movies)) addWithId:movie];
        (void) [((id<JavaUtilMap>) nil_chk(symbols)) putWithId:[((TripleplayFlumpMovie_Symbol *) nil_chk(movie)) name] withId:movie];
      }
    }
    id<PlaynCoreJson_TypedArray> textureGroups = [((id<PlaynCoreJson_Object>) nil_chk(json)) getArrayWithNSString:@"textureGroups" withIOSClass:[IOSClass classWithProtocol:@protocol(PlaynCoreJson_Object)]];
    id<PlaynCoreJson_TypedArray> atlases = [((id<PlaynCoreJson_Object>) nil_chk([((id<PlaynCoreJson_TypedArray>) nil_chk(textureGroups)) getWithInt:0])) getArrayWithNSString:@"atlases" withIOSClass:[IOSClass classWithProtocol:@protocol(PlaynCoreJson_Object)]];
    ReactValue *remainingAtlases = [ReactValue createWithId:[JavaLangInteger valueOfWithInt:[((id<PlaynCoreJson_TypedArray>) nil_chk(atlases)) length]]];
    (void) [((ReactValue *) nil_chk(remainingAtlases)) connectNotifyWithReactValueView_Listener:[[TripleplayFlumpLibrary_$1 alloc] initWithTripleplayFlumpLibrary:self withJavaUtilArrayList:movies withJavaUtilMap:symbols withPlaynCoreUtilCallback:callback]];
    {
      id<JavaUtilIterator> iter__ = [((id<PlaynCoreJson_TypedArray>) nil_chk(atlases)) iterator];
      while ([((id<JavaUtilIterator>) nil_chk(iter__)) hasNext]) {
        id<PlaynCoreJson_Object> atlasJson = [((id<JavaUtilIterator>) nil_chk(iter__)) next];
        id<PlaynCoreImage> atlas = [((id<PlaynCoreAssets>) nil_chk([PlaynCorePlayN assets])) getImageWithNSString:[NSString stringWithFormat:@"%@/%@", baseDir, [((id<PlaynCoreJson_Object>) nil_chk(atlasJson)) getStringWithNSString:@"file"]]];
        [((id<PlaynCoreImage>) nil_chk(atlas)) addCallbackWithPlaynCoreUtilCallback:[[TripleplayFlumpLibrary_$2 alloc] initWithPlaynCoreUtilCallback:callback withPlaynCoreJson_Object:atlasJson withJavaUtilMap:symbols withReactValue:remainingAtlases]];
      }
    }
  }
  return self;
}

+ (void)fromAssetsWithNSString:(NSString *)baseDir
     withPlaynCoreUtilCallback:(id<PlaynCoreUtilCallback>)callback {
  (void) [PlaynCoreAsserts checkNotNullWithId:callback];
  [((id<PlaynCoreAssets>) nil_chk([PlaynCorePlayN assets])) getTextWithNSString:[NSString stringWithFormat:@"%@/library.json", baseDir] withPlaynCoreUtilCallback:[[TripleplayFlumpLibrary_$3 alloc] initWithPlaynCoreUtilCallback:callback withNSString:baseDir withPlaynCoreUtilCallback:callback]];
}

- (id<TripleplayFlumpInstance>)createInstanceWithNSString:(NSString *)symbolName {
  id<TripleplayFlumpSymbol> symbol = [((id<JavaUtilMap>) nil_chk(symbols_)) getWithId:symbolName];
  if (symbol == nil) {
    @throw [[JavaLangIllegalArgumentException alloc] initWithNSString:[NSString stringWithFormat:@"Missing required symbol [name=%@]", symbolName]];
  }
  return [((id<TripleplayFlumpSymbol>) nil_chk(symbol)) createInstance];
}

- (TripleplayFlumpMovie *)createMovieWithNSString:(NSString *)symbolName {
  return (TripleplayFlumpMovie *) [self createInstanceWithNSString:symbolName];
}

- (TripleplayFlumpTexture *)createTextureWithNSString:(NSString *)symbolName {
  return (TripleplayFlumpTexture *) [self createInstanceWithNSString:symbolName];
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayFlumpLibrary *typedCopy = (TripleplayFlumpLibrary *) copy;
  typedCopy.frameRate = frameRate_;
  typedCopy.symbols = symbols_;
}

@end
@implementation TripleplayFlumpLibrary_$1

@synthesize this$0 = this$0_;
@synthesize val$movies = val$movies_;
@synthesize val$symbols = val$symbols_;
@synthesize val$callback = val$callback_;

- (void)onChangeWithId:(JavaLangInteger *)remaining
                withId:(JavaLangInteger *)_ {
  if ([((JavaLangInteger *) nil_chk(remaining)) intValue] > 0) return;
  {
    id<JavaUtilIterator> iter__ = [((JavaUtilArrayList *) nil_chk(val$movies_)) iterator];
    while ([((id<JavaUtilIterator>) nil_chk(iter__)) hasNext]) {
      TripleplayFlumpMovie_Symbol *movie = [((id<JavaUtilIterator>) nil_chk(iter__)) next];
      {
        id<JavaUtilIterator> iter__ = [((id<JavaUtilList>) nil_chk(((TripleplayFlumpMovie_Symbol *) nil_chk(movie)).layers)) iterator];
        while ([((id<JavaUtilIterator>) nil_chk(iter__)) hasNext]) {
          TripleplayFlumpLayerData *layer = [((id<JavaUtilIterator>) nil_chk(iter__)) next];
          {
            id<JavaUtilIterator> iter__ = [((id<JavaUtilList>) nil_chk(((TripleplayFlumpLayerData *) nil_chk(layer)).keyframes)) iterator];
            while ([((id<JavaUtilIterator>) nil_chk(iter__)) hasNext]) {
              TripleplayFlumpKeyframeData *kf = [((id<JavaUtilIterator>) nil_chk(iter__)) next];
              if (((TripleplayFlumpKeyframeData *) nil_chk(kf))._symbolName != nil) {
                id<TripleplayFlumpSymbol> symbol = [((id<JavaUtilMap>) nil_chk(val$symbols_)) getWithId:((TripleplayFlumpKeyframeData *) nil_chk(kf))._symbolName];
                (void) [PlaynCoreAsserts checkNotNullWithId:symbol];
                if (((TripleplayFlumpLayerData *) nil_chk(layer))._lastSymbol == nil) ((TripleplayFlumpLayerData *) nil_chk(layer))._lastSymbol = symbol;
                else if (((TripleplayFlumpLayerData *) nil_chk(layer))._lastSymbol != symbol) ((TripleplayFlumpLayerData *) nil_chk(layer))._multipleSymbols = YES;
                ((TripleplayFlumpKeyframeData *) nil_chk(kf))._symbol = symbol;
              }
            }
          }
        }
      }
    }
  }
  [((id<PlaynCoreUtilCallback>) nil_chk(val$callback_)) onSuccessWithId:this$0_];
}

- (id)initWithTripleplayFlumpLibrary:(TripleplayFlumpLibrary *)outer$
               withJavaUtilArrayList:(JavaUtilArrayList *)capture$0
                     withJavaUtilMap:(id<JavaUtilMap>)capture$1
           withPlaynCoreUtilCallback:(id<PlaynCoreUtilCallback>)capture$2 {
  if ((self = [super init])) {
    this$0_ = outer$;
    val$movies_ = capture$0;
    val$symbols_ = capture$1;
    val$callback_ = capture$2;
  }
  return self;
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayFlumpLibrary_$1 *typedCopy = (TripleplayFlumpLibrary_$1 *) copy;
  typedCopy.this$0 = this$0_;
  typedCopy.val$movies = val$movies_;
  typedCopy.val$symbols = val$symbols_;
  typedCopy.val$callback = val$callback_;
}

@end
@implementation TripleplayFlumpLibrary_$2

@synthesize val$atlasJson = val$atlasJson_;
@synthesize val$symbols = val$symbols_;
@synthesize val$remainingAtlases = val$remainingAtlases_;

- (void)onSuccessWithId:(id<PlaynCoreImage>)atlas {
  {
    id<JavaUtilIterator> iter__ = [((id<PlaynCoreJson_TypedArray>) nil_chk([((id<PlaynCoreJson_Object>) nil_chk(val$atlasJson_)) getArrayWithNSString:@"textures" withIOSClass:[IOSClass classWithProtocol:@protocol(PlaynCoreJson_Object)]])) iterator];
    while ([((id<JavaUtilIterator>) nil_chk(iter__)) hasNext]) {
      id<PlaynCoreJson_Object> textureJson = [((id<JavaUtilIterator>) nil_chk(iter__)) next];
      TripleplayFlumpTexture_Symbol *texture = [[TripleplayFlumpTexture_Symbol alloc] initWithPlaynCoreJson_Object:textureJson withPlaynCoreImage:atlas];
      (void) [((id<JavaUtilMap>) nil_chk(val$symbols_)) putWithId:[((TripleplayFlumpTexture_Symbol *) nil_chk(texture)) name] withId:texture];
    }
  }
  (void) [((ReactValue *) nil_chk(val$remainingAtlases_)) updateWithId:[JavaLangInteger valueOfWithInt:[((JavaLangInteger *) nil_chk([((ReactValue *) nil_chk(val$remainingAtlases_)) get])) intValue] - 1]];
}

- (id)initWithPlaynCoreUtilCallback:(id<PlaynCoreUtilCallback>)arg$0
           withPlaynCoreJson_Object:(id<PlaynCoreJson_Object>)capture$0
                    withJavaUtilMap:(id<JavaUtilMap>)capture$1
                     withReactValue:(ReactValue *)capture$2 {
  if ((self = [super initWithPlaynCoreUtilCallback:arg$0])) {
    val$atlasJson_ = capture$0;
    val$symbols_ = capture$1;
    val$remainingAtlases_ = capture$2;
  }
  return self;
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayFlumpLibrary_$2 *typedCopy = (TripleplayFlumpLibrary_$2 *) copy;
  typedCopy.val$atlasJson = val$atlasJson_;
  typedCopy.val$symbols = val$symbols_;
  typedCopy.val$remainingAtlases = val$remainingAtlases_;
}

@end
@implementation TripleplayFlumpLibrary_$3

@synthesize val$baseDir = val$baseDir_;
@synthesize val$callback = val$callback_;

- (void)onSuccessWithId:(NSString *)text {
  @try {
    (void) [[TripleplayFlumpLibrary alloc] initWithPlaynCoreJson_Object:[((id<PlaynCoreJson>) nil_chk([PlaynCorePlayN json])) parseWithNSString:text] withNSString:val$baseDir_ withPlaynCoreUtilCallback:val$callback_];
  }
  @catch (JavaLangException *err) {
    [((id<PlaynCoreUtilCallback>) nil_chk(val$callback_)) onFailureWithJavaLangThrowable:err];
  }
}

- (id)initWithPlaynCoreUtilCallback:(id<PlaynCoreUtilCallback>)arg$0
                       withNSString:(NSString *)capture$0
          withPlaynCoreUtilCallback:(id<PlaynCoreUtilCallback>)capture$1 {
  if ((self = [super initWithPlaynCoreUtilCallback:arg$0])) {
    val$baseDir_ = capture$0;
    val$callback_ = capture$1;
  }
  return self;
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  TripleplayFlumpLibrary_$3 *typedCopy = (TripleplayFlumpLibrary_$3 *) copy;
  typedCopy.val$baseDir = val$baseDir_;
  typedCopy.val$callback = val$callback_;
}

@end
